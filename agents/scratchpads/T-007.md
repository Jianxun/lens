## Task summary
- Implement streaming `/chat` endpoint using student portal `/v1/chat/completions`.
- Orchestrate retrieval tools (`/retrieval/peek`, `/retrieval/turn`) with multi-pass histogram, 50k token cap, capped hydrated turns, truncation, fixed embedding model, and cited `turn_ids` + histogram in metadata.
- DoD verify: live call streams tokens; metadata carries cited turn_ids + histogram; logs show tool calls and capped hydration.

## Read
- `agents/context/tasks.md`
- `agents/context/handoff.md`
- `backend/main.py`
- `backend/api/retrieval.py`
- `docs/student_portal/ai_builder_api.md`

## Plan
1) Update tasks status + scratchpad (this file).  
2) Implement retrieval-aware agent service (`backend/services/agent.py`) that runs peek/turn multi-pass, caps turns, truncates.  
3) Add OpenAI-compatible streaming `/chat` router calling portal with appended retrieval context + metadata.  
4) Wire router in `backend/main.py`, update handoff + verify notes.  
5) Run smoke checks (lint? manual) and record results.

## Progress log
- 2025-12-25: Rewired orchestrator to be LLM-driven with tool calls (peek/turn), using legacy system prompt; added hydration caps and truncation.
- 2025-12-25: Updated `/chat` router to stream the orchestratorâ€™s final answer and metadata (cited turn_ids + histogram) without SQL-first retrieval.
- 2025-12-25: Added `scripts/orchestrator_smoke.py` non-stream smoke; ran successfully with OPENAI_BASE_URL=https://api.openai.com/v1/ and model gpt-5.1 (10 cited_turn_ids, 5 histogram buckets).

## Patch summary
- `backend/services/agent.py`: LLM tool-driven orchestrator using peek/turn APIs, hydration caps, truncation, streaming chunk builder.
- `backend/api/chat.py`: `/chat` streams orchestrator answer + metadata chunk (cited turn_ids + histogram).

## Verification
- `python scripts/orchestrator_smoke.py "Summarize recent progress on the Lens project."` (pass; answer prefix + cited_turn_ids + histogram printed)

## Blockers / Questions
- None yet.

## Next steps
- Smoke test `/chat` streaming with portal key loaded; confirm metadata chunk and citations.
- Record results + update tasks/handoff, prepare PR once verified.

