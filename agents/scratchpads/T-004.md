# T-004 — Database schema & migrations

## Task summary
- Implement Postgres schema per ADRs (0001–0006): conversations, messages, message_embeddings (UUID PK), sessions, session_messages, ingest_runs.
- Enforce roles (user/assistant), idx ordering, uniqueness, truncation (content_text <= 32k, turn_summary <= 4k).
- Provide initial migration SQL + README setup/verify steps; add docker-compose Postgres with pgvector.
- Verify: `psql -f migrations/0001_init.sql` on fresh DB; `psql -c "\\dt"` shows expected tables.

## Read
- agents/context/tasks.md
- agents/context/contract.md
- agents/context/handoff.md
- agents/context/lessons.md
- agents/adr/ADR-0001..0007

## Plan
- Prep: mark task In Progress, create branch `feature/T-004-db-schema`.
- Write migration `migrations/0001_init.sql` with extensions, tables, constraints, indexes.
- Add `docker-compose.yml` for Postgres + pgvector; env-driven creds/volume/ports.
- Update README with DB setup, docker compose usage, migration + verify steps.
- Verify locally with `psql` commands; update scratchpad/handoff.

## Decisions / Notes
- Embedding vector kept flexible (store dim + CHECK vector_dims matches dim; provider/model columns present).
- Length limits: content_text 32k chars, turn_summary 4k.
- Roles restricted to user/assistant.

## Progress log
- 2025-12-25: Reviewed tasks/contract/ADRs; set T-004 to In Progress; created branch `feature/T-004-db-schema`; recorded plan.
- 2025-12-25: Added initial migration `migrations/0001_init.sql` with extensions, tables, constraints, and indexes per ADRs; added docker-compose Postgres + pgvector; drafted README setup/verify instructions; updated codebase_map.
- 2025-12-25: Ran compose on port 5433 due to local conflict; initial migration failed on ivfflat because vector column lacked dimension; adjusted message_embeddings to use vector(3072) with dim default 3072 and reran prep.
- 2025-12-25: Migration failed again due to index dimension limit (>2000). Removed vector index (pgvector limits for ivfflat/hnsw at 2000 dims); keep vector(3072) + dim; documented index omission in README. Pending rerun after reset.
- 2025-12-25: Added pgweb service to docker-compose (port PGWEB_PORT, default 8081) and documented usage in README for DB inspection.

## Patch summary
- migrations/0001_init.sql — schema definitions, constraints, indexes, extensions.
- docker-compose.yml — local Postgres with pgvector and defaults.
- README.md — DB setup, compose usage, migration + verification commands, pgweb instructions.
- agents/context/codebase_map.md — note migrations and compose.

## Verification
- 2025-12-25: `POSTGRES_PORT=5433 docker compose up -d db`; `cat migrations/0001_init.sql | POSTGRES_PORT=5433 docker compose exec -T db psql -U lens -d lens` → COMMIT.
- `docker compose exec -T db psql -U lens -d lens -c "\\dt"` shows tables: conversations, ingest_runs, message_embeddings, messages, session_messages, sessions.
- `\\d messages` confirms role CHECK (user/assistant), idx >=0, unique (conversation_id, idx_in_conv), length guards (content_text <= 32000, turn_summary <= 4000).
- `\\d message_embeddings` confirms vector(3072) with dim default 3072, unique (user_message_id, provider, model); no vector index (pgvector >2000 dim limit).

## Blockers / Questions
- None.

## Next steps
- Update handoff with verification status.

