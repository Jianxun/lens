# T-006 â€” Retrieval API
## Task summary
- Implement `/retrieval/peek` and `/retrieval/turn/{id}` per ADR-0004 with fixed embedding model `text-embedding-3-large`; top_k=100 default; UTC binning.
- Return histogram over top_k and snippets for top few.
- Verify:
  - `GET /retrieval/peek` returns histogram + snippets on seeded data.
  - `GET /retrieval/turn/{id}` returns full turn content for a known id.

## Read
- `agents/context/tasks.md` (status, DoD)
- `agents/adr/ADR-0004-retrieval-strategy.md`
- `migrations/0001_init.sql`
- `backend/ingest/pipeline.py`
- `backend/embeddings/pipeline.py`

## Plan
- Task bookkeeping: mark T-006 In Progress, update handoff/scratchpad, create `feature/T-006-retrieval-api`.
- Scaffold FastAPI app/routing/deps under `backend/` with retrieval router.
- Implement `/retrieval/peek`: embed query via student portal, vector search top_k, histogram by bin_days, return matches top_n_snippets.
- Implement `/retrieval/turn/{id}`: hydrate turn by embedding id with metadata, summary preference.
- Wire, verify manually (uvicorn + sample calls), update docs/handoff.

## Progress log
- 2025-12-25: Created branch `feature/T-006-retrieval-api`; set T-006 to In Progress; reviewing ADRs and schema.
- 2025-12-25: Added FastAPI app scaffold (`backend/main.py`), retrieval router with `/retrieval/peek` (bin_days histogram, top_k/top_n, student portal embeddings) and `/retrieval/turn/{id}` hydration, plus backend requirements and codebase map update.
- 2025-12-25: Sourced `.env` to load `SUPER_MIND_API_KEY`; queried DB for sample turn id; ran uvicorn and verified `/retrieval/peek` and `/retrieval/turn` against seeded data; updated README and lessons.

## Patch summary
- `backend/main.py`: FastAPI app wiring with DSN + embedding client bootstrap.
- `backend/api/retrieval.py`: `/retrieval/peek` and `/retrieval/turn/{id}` endpoints with bin_days histogram, vector search, and hydration.
- `backend/api/__init__.py`: package stub.
- `backend/requirements.txt`: dependencies for FastAPI/httpx/psycopg.
- `agents/context/tasks.md`, `agents/context/codebase_map.md`: status/link/map updates for T-006.
- `README.md`: retrieval API run and curl instructions.

## Verification
- Env: `set -a && source .env && set +a` (loads `SUPER_MIND_API_KEY`).
- DB sample turn: `.venv/bin/python - <<'PY' ... select id from message_embeddings limit 1` -> `3a7d7fc5-1f44-41ec-8451-00c9caceaba5`.
- Started API: `.venv/bin/uvicorn backend.main:app --host 0.0.0.0 --port 8000`.
- Peek: `curl http://localhost:8000/retrieval/peek?query=hello&bin_days=1&top_k=10&top_n_snippets=3` -> histogram buckets returned with total=10; matches include turn_id `4ad6f7f2-1442-4fef-a4f3-6109a4d81d4b`.
- Turn: `curl http://localhost:8000/retrieval/turn/4ad6f7f2-1442-4fef-a4f3-6109a4d81d4b` -> returned user/assistant content, provider/model, used_turn_summary=false.
- Stopped uvicorn via `pkill -f "uvicorn backend.main:app"`.

## Blockers / Questions
- None currently.

## Next steps
- None; task complete pending review.

