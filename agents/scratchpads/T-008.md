# T-008 — Sessions API & persistence

## Task summary
- DoD: Implement `/sessions` list/get/create/patch/delete (soft archive) and link messages to sessions with linear ordering. Ensure only finalized messages are stored; no superseded drafts.
- Verify: CRUD works in manual tests; `session_messages` reflect message order; archived sessions hidden from default list.
- Allowed files: `backend/api/sessions.py`, `backend/models/`, `backend/main.py`.

## Read
- `agents/context/lessons.md`
- `agents/context/contract.md`
- `agents/context/tasks.md`
- `agents/context/handoff.md`
- `agents/adr/ADR-0006-sessions-and-api.md`
- `backend/main.py`
- `backend/api/chat.py`
- `backend/services/agent.py`
- `backend/api/retrieval.py`
- `backend/ingest/pipeline.py`
- `migrations/0001_init.sql`

## Plan
1) Set task In Progress, create feature branch, ensure scratchpad updated.  
2) Add session/conversation DB helpers (create/list/get/patch/archive, append turn with idx sequencing and create_time fallback).  
3) Build FastAPI router `backend/api/sessions.py` with list/get/create/patch/delete (soft archive) per ADR-0006.  
4) Wire `/chat` + `AgentService` to accept optional session_id, create session+conversation when absent, persist finalized user/assistant messages into `messages` and `session_messages` with sequential idx. Return session_id in metadata.  
5) Include router in `backend/main.py`; run `python -m compileall backend` and manual smoke; update context + todos.

## Progress log
- Created branch `feature/T-008-sessions-api`; set T-008 to In Progress in tasks.md; updated scratchpad structure.
- Added `backend/models/sessions.py` helpers (session CRUD, conversation binding, idx sequencing, append_turn) and package init.
- Implemented `backend/api/sessions.py` with list/get/create/patch/delete (soft archive) using DB dependency.
- Wired `/sessions` router into `backend/main.py`.
- Extended chat flow to accept optional session_id, persist user/assistant turns, and return session/message ids in metadata (updates in `backend/api/chat.py`, `backend/services/agent.py`).
- Smoke: `.venv/bin/python -m compileall backend` (pass).
- Manual DB smoke via models: create session, append turn, verify counts/ordering (session_id `cd9e2457-1e05-4900-9765-6fbd74eac33d`, message_count 2, idx [0,1]).
- Patched/pinned and soft-archived the smoke session; confirmed archived session hidden from default list and listed when include_archived=True.

## Patch summary
- `backend/models/sessions.py`: session/conversation helpers, turn persistence with linear idx and content limits.
- `backend/models/__init__.py`: export session helpers.
- `backend/api/sessions.py`: FastAPI router for CRUD + history.
- `backend/main.py`: register sessions router.
- `backend/api/chat.py`: accept session_id, hand through to persistence.
- `backend/services/agent.py`: persist finalized turns, return session/message metadata.

## Verification
- `.venv/bin/python -m compileall backend` ✅
- Manual model smoke (create session + append turn) ✅
- Manual CRUD smoke: patch/pin session then soft archive; archived filtered from default list ✅

## Blockers / Questions
- None yet.

## Next steps
- Push branch and open PR referencing T-008 and scratchpad.
- Optional: run API-level smoke via FastAPI once server is up.

